<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roombeat SMS OTP</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0B47FF;color:white}
.wrap{max-width:900px;margin:0 auto;padding:20px}
.btn{padding:10px 15px;border-radius:10px;border:2px solid #000;cursor:pointer;font-weight:700}
.btn.primary{background:#FFD447;color:#000}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
.box{background:white;color:black;padding:20px;border-radius:12px;border:2px solid #000;width:90%;max-width:400px}
input{width:100%;padding:10px;border-radius:10px;border:2px solid #000;margin-bottom:10px}
#map{height:70vh;border-radius:10px;border:2px solid #000;margin-top:20px}
.route{display:none}
.route.active{display:block}
</style>
</head>

<body>

<div class="wrap">
  <h1>Roombeat</h1>
  <button id="openAuth" class="btn primary">Sign in (SMS OTP)</button>

  <div id="route-home" class="route active">
    <p>Welcome. Please sign in.</p>
  </div>

  <div id="route-map" class="route">
    <h2>Map</h2>
    <div id="map"></div>
  </div>
</div>

<div id="authModal" class="modal">
  <div class="box">
    <h3>Telefonla Giriş</h3>

    <input id="phoneInput" placeholder="+90 541 884 9154">
    <button id="sendPhoneOtp" class="btn primary">SMS Gönder</button>

    <div id="otpStep" style="display:none;margin-top:10px;">
      <input id="otpInput" placeholder="Kod">
      <button id="verifyPhoneOtp" class="btn primary">Doğrula</button>
    </div>

    <button id="closeAuth" class="btn">Kapat</button>
  </div>
</div>

<script>
const supa = window.supabase.createClient(
 "https://toslxiowcosjayynwqdc.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc2x4aW93Y29zanlheW53cWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NTIyMzIsImV4cCI6MjA3ODIyODIzMn0.6mSSo03x2O4nKBQ5KoOEQ2VMPrp69sFY2pygpjBvCIo"
);

const modal = document.getElementById("authModal");
document.getElementById("openAuth").onclick = ()=> modal.style.display="flex";
document.getElementById("closeAuth").onclick = ()=> modal.style.display="none";

document.getElementById("sendPhoneOtp").onclick = async()=>{
  const phone = document.getElementById("phoneInput").value.trim();
  const { error } = await supa.auth.signInWithOtp({ phone });
  if(error){ alert(error.message); return; }
  document.getElementById("otpStep").style.display="block";
  alert("SMS gönderildi!");
};

document.getElementById("verifyPhoneOtp").onclick = async()=>{
  const phone = document.getElementById("phoneInput").value.trim();
  const code = document.getElementById("otpInput").value.trim();

  const { data, error } = await supa.auth.verifyOtp({
    phone,
    token: code,
    type:"sms"
  });

  if(error){ alert(error.message); return; }

  alert("Giriş başarılı!");
  modal.style.display="none";
  loadMap();
};

function loadMap(){
  document.getElementById("route-home").classList.remove("active");
  document.getElementById("route-map").classList.add("active");

  const map = L.map("map").setView([40.99,29.027],14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([40.9878,29.0277]).addTo(map).bindPopup("House 1");
}
</script>

</body>
</html>
